<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>八年級的回憶攻擊</title>
  <style>
    :root { --primary:#4f46e5; --bg:#f6f7fb; --card:#ffffff; --text:#1f2937; }
    *{box-sizing:border-box} body{
      margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      background:var(--bg); color:var(--text);
      -webkit-tap-highlight-color: transparent;
    }
    .wrap{max-width:720px;margin:0 auto;padding:16px 16px 64px}
    header{display:flex;align-items:center;justify-content:space-between;margin:8px 0 16px}
    h1{font-size:20px;margin:0; user-select:none; cursor:default;}
    .card{background:var(--card);border-radius:16px;padding:16px;
      box-shadow:0 6px 20px rgba(0,0,0,.06)}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .btn{
      appearance:none;border:none;border-radius:12px;padding:12px 16px;
      background:var(--primary);color:#fff;font-weight:600;cursor:pointer;
      width:100%;
    }
    .btn[disabled]{opacity:.5;cursor:not-allowed}
    .ghost{background:#e5e7eb;color:#111}
    .q-text{font-size:18px;line-height:1.5;margin:0 0 12px}
    .choice{border:1px solid #e5e7eb;border-radius:12px;padding:12px;
      display:flex;align-items:center;gap:10px;background:#fff}
    .choice input{width:20px;height:20px}
    .meta{display:flex;justify-content:space-between;align-items:center;font-size:14px;color:#6b7280;margin:8px 0 16px}
    .pill{padding:6px 10px;border-radius:999px;background:#eef2ff;color:#4338ca;font-weight:700}
    .timer{font-variant-numeric:tabular-nums; visibility:hidden;}
    .footer{position:fixed;left:0;right:0;bottom:0;background:rgba(255,255,255,.9);
      border-top:1px solid #e5e7eb;backdrop-filter: blur(6px)}
    .footer .inner{max-width:720px;margin:0 auto;padding:10px 16px;display:flex;gap:12px;flex-wrap:wrap}
    .result h2{margin:0 0 8px}
    .small{font-size:12px;color:#6b7280}
    dialog{border:none;border-radius:16px;padding:0;max-width:820px;width:92%}
    .dlg-hd{padding:14px 16px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center}
    .dlg-bd{padding:16px}
    textarea{width:100%;min-height:300px;border:1px solid #e5e7eb;border-radius:12px;padding:12px;font-family:ui-monospace,monospace}
    .hidden{display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1 id="title">八年級的回憶攻擊</h1>
      <div class="row">
        <span id="admin-badge" class="small" style="display:none;color:#4338ca">管理模式</span>
      </div>
    </header>

    <div id="last" class="card" style="display:none;margin-bottom:12px;"></div>

    <div id="quiz" class="card" style="display:none;">
      <div class="meta">
        <div><span id="progress" class="pill">1/1</span></div>
        <div class="timer">剩餘 <span id="remain">10:00</span></div>
      </div>
      <h2 id="q" class="q-text"></h2>
      <div id="choices" style="display:grid;gap:10px;"></div>
    </div>

    <div id="result" class="card result" style="display:none;"></div>

    <div id="home" class="card">
      <p style="margin:0 0 12px;">這是手機瀏覽器就能玩的測驗。選擇模式開始作答：</p>
      <div class="row" style="margin-top:8px">
        <button id="start-free" class="btn">開始測驗（不限時）</button>
        <button id="start-10m" class="btn">開始測驗（限時 10 分鐘）</button>
      </div>
      <p id="admin-hint" class="small hidden" style="margin-top:10px">
        已進入管理模式：點右下「管理題庫」可檢視/編輯；或用網址參數 ?admin=1 進入。
      </p>
    </div>
  </div>

  <div class="footer">
    <div class="inner">
      <button id="next" class="btn" disabled>下一題</button>
      <button id="submit" class="btn ghost" disabled>交卷</button>
      <button id="admin-open" class="btn hidden">管理題庫</button>
      <button id="admin-exit" class="btn ghost hidden">退出管理模式</button>
    </div>
  </div>

  <dialog id="dlg">
    <div class="dlg-hd">
      <strong>題庫管理</strong>
      <button id="dlg-close" class="ghost" style="border:none;background:#eee;border-radius:8px;padding:6px 10px;cursor:pointer">關閉</button>
    </div>
    <div class="dlg-bd">
      <textarea id="editor-ta"></textarea>
      <div class="row" style="margin-top:10px">
        <button id="save-bank" class="btn">儲存題庫</button>
        <button id="reset-bank" class="btn">恢復預設</button>
      </div>
    </div>
  </dialog>

<script>
const ADMIN_CODE = "rouye-quiz-2025";
const URL_ENABLE_ADMIN = true;

/** 題庫：新增 3 題是非題 */
const DEFAULT_BANK = [
  {"q":"下列哪個是哺乳類？","choices":["青蛙","鯨魚","麻雀","烏龜"],"answer":1},
  {"q":"2 + 2 = ?","choices":["3","4","5","22"],"answer":1},
  {"q":"台灣最高峰？","choices":["雪山","玉山","合歡主峰","南湖大山"],"answer":1},
  {"q":"地球是平的？","choices":["是","否"],"answer":1},
  {"q":"水在攝氏100度會沸騰？","choices":["是","否"],"answer":0},
  {"q":"人類可以在月球上呼吸？","choices":["是","否"],"answer":1}
];

const $ = sel => document.querySelector(sel);
let bank = loadBank(); let idx=0,score=0,selected=null,enableTimer=false,duration=0,remaining=0,tick=null,startedAt=null,adminMode=false;

function loadBank(){ try{const s=localStorage.getItem('quiz_bank');if(!s)return structuredClone(DEFAULT_BANK);const arr=JSON.parse(s);return Array.isArray(arr)?arr:structuredClone(DEFAULT_BANK);}catch{return structuredClone(DEFAULT_BANK);} }
function saveBank(arr){ localStorage.setItem('quiz_bank', JSON.stringify(arr)); }
function show(el,on=true){ el.classList.toggle('hidden',!on); }
function toMMSS(sec){ const m=Math.floor(sec/60),s=sec%60; return `${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`; }

/** 隨機排序工具 */
function shuffle(arr){ return arr.map(v=>[Math.random(),v]).sort((a,b)=>a[0]-b[0]).map(v=>v[1]); }

(function detectAdmin(){
  function enterAdminFlow(){
    const code=prompt("請輸入管理密碼：");
    if(code===ADMIN_CODE){ adminMode=true; activateAdminUI(); }
    else if(code!==null){ alert("密碼錯誤"); }
  }
  if(URL_ENABLE_ADMIN && new URLSearchParams(location.search).get('admin')==='1'){ setTimeout(enterAdminFlow,10); }
  let taps=0,tapTimer=null;
  $('#title').addEventListener('click',()=>{ taps++;clearTimeout(tapTimer); tapTimer=setTimeout(()=>taps=0,600); if(taps>=5){taps=0;enterAdminFlow();}});
})();
function activateAdminUI(){ $('#admin-badge').style.display=''; show($('#admin-hint'),true); show($('#admin-open'),true); show($('#admin-exit'),true); }
function deactivateAdminUI(){ adminMode=false; $('#admin-badge').style.display='none'; show($('#admin-hint'),false); show($('#admin-open'),false); show($('#admin-exit'),false); }

function updateLast(){ const s=localStorage.getItem('last_score'); const t=localStorage.getItem('last_seconds'); const box=$('#last'); if(s){box.style.display=''; box.innerHTML=`<b>上次成績：</b>${s} 分 <span class="small">（花費 ${t ?? '-'} 秒）</span>`;}else box.style.display='none';}
updateLast();

$('#start-free').onclick=()=>startQuiz({timed:false});
$('#start-10m').onclick=()=>startQuiz({timed:true,seconds:600});
$('#next').onclick=nextQuestion;
$('#submit').onclick=finishQuiz;
$('#admin-open').onclick=openEditor;
$('#admin-exit').onclick=deactivateAdminUI;
$('#dlg-close').onclick=()=>$('#dlg').close();
$('#save-bank').onclick=saveEditor;
$('#reset-bank').onclick=()=>{saveBank(DEFAULT_BANK);bank=loadBank();$('#editor-ta').value=JSON.stringify(bank,null,2);alert('已恢復預設題庫。');};

function startQuiz({timed,seconds=0}){ 
  bank=shuffle(loadBank()); // 題目隨機順序
  idx=0;score=0;selected=null;startedAt=Date.now(); enableTimer=!!timed; duration=seconds; remaining=duration; clearInterval(tick);
  $('#remain').textContent=enableTimer?toMMSS(remaining):'—'; $('.timer').style.visibility=enableTimer?'visible':'hidden'; $('#submit').disabled=false; $('#next').disabled=true; $('#home').style.display='none'; $('#result').style.display='none'; $('#quiz').style.display=''; renderQuestion();
  if(enableTimer){ tick=setInterval(()=>{remaining--; $('#remain').textContent=toMMSS(Math.max(0,remaining)); if(remaining<=0){finishQuiz();}},1000);} 
}
function renderQuestion(){ 
  const q=bank[idx];
  // 打亂選項，並記錄新答案位置
  const choicesWithIndex=q.choices.map((c,i)=>({text:c,idx:i}));
  const shuffled=shuffle(choicesWithIndex);
  const newAnswerIndex=shuffled.findIndex(c=>c.idx===q.answer);
  q._shuffledChoices=shuffled.map(c=>c.text);
  q._shuffledAnswer=newAnswerIndex;

  $('#progress').textContent=`${idx+1}/${bank.length}`; 
  $('#q').textContent=q.q; 
  const box=$('#choices'); 
  box.innerHTML=''; 
  q._shuffledChoices.forEach((text,i)=>{ 
    const div=document.createElement('label'); 
    div.className='choice'; 
    div.innerHTML=`<input type="radio" name="c${idx}" /> <span>${text}</span>`; 
    div.onclick=()=>{selected=i; $('#next').disabled=false; $('#next').textContent=(idx===bank.length-1)?'交卷':'下一題';}; 
    box.appendChild(div); 
  }); 
}
function nextQuestion(){ if(idx===bank.length-1){finishQuiz();return;} if(selected===bank[idx]._shuffledAnswer)score++; idx++;selected=null;$('#next').disabled=true;renderQuestion();}
function finishQuiz(){ clearInterval(tick); if(selected!==null&&idx<bank.length){if(selected===bank[idx]._shuffledAnswer)score++;} const elapsed=Math.max(1,Math.round((Date.now()-startedAt)/1000)); const total=bank.length; const pct=Math.round((score/total)*100); localStorage.setItem('last_score',String(score)); localStorage.setItem('last_seconds',String(elapsed)); updateLast();
  $('#result').innerHTML=`<h2>成績：${score} / ${total}</h2><p class="small">正確率 ${pct}% ・ 花費 ${elapsed} 秒${enableTimer?`（限時 ${toMMSS(duration)}）`:''}</p><div class="row" style="margin-top:8px"><button class="btn" onclick="startQuiz({timed:${enableTimer},seconds:${duration}})">再測一次</button><button class="btn ghost" onclick="(document.querySelector('#result').style.display='none',document.querySelector('#home').style.display='')">回首頁</button></div>`; $('#quiz').style.display='none';$('#home').style.display='none';$('#result').style.display='';$('#next').disabled=true;$('#submit').disabled=true; }
function openEditor(){ $('#editor-ta').value=JSON.stringify(loadBank(),null,2); $('#dlg').showModal(); }
function saveEditor(){ try{const arr=JSON.parse($('#editor-ta').value); if(!Array.isArray(arr))throw new Error('格式需為陣列'); for(const it of arr){ if(typeof it.q!=='string'||!Array.isArray(it.choices)||typeof it.answer!=='number') throw new Error('每題需包含 q、choices、answer'); } saveBank(arr); bank=loadBank(); alert('已儲存題庫！'); $('#dlg').close(); }catch(err){alert('存檔失敗：'+err.message);} }
</script>
</body>
</html>
