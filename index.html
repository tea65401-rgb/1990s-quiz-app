<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>小言測驗（Web）</title>
  <style>
    :root { --primary:#4f46e5; --bg:#f6f7fb; --card:#ffffff; --text:#1f2937; }
    *{box-sizing:border-box} body{
      margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      background:var(--bg); color:var(--text);
      -webkit-tap-highlight-color: transparent;
    }
    .wrap{max-width:720px;margin:0 auto;padding:16px 16px 64px}
    header{display:flex;align-items:center;justify-content:space-between;margin:8px 0 16px}
    h1{font-size:20px;margin:0; user-select:none; cursor:default;}
    .card{background:var(--card);border-radius:16px;padding:16px;
      box-shadow:0 6px 20px rgba(0,0,0,.06)}
    .row{display:flex;gap:12px;align-items:center}
    .btn{
      appearance:none;border:none;border-radius:12px;padding:12px 16px;
      background:var(--primary);color:#fff;font-weight:600;cursor:pointer;
      width:100%;
    }
    .btn[disabled]{opacity:.5;cursor:not-allowed}
    .ghost{background:#e5e7eb;color:#111}
    .q-text{font-size:18px;line-height:1.5;margin:0 0 12px}
    .choice{border:1px solid #e5e7eb;border-radius:12px;padding:12px;
      display:flex;align-items:center;gap:10px;background:#fff}
    .choice input{width:20px;height:20px}
    .meta{display:flex;justify-content:space-between;align-items:center;font-size:14px;color:#6b7280;margin:8px 0 16px}
    .pill{padding:6px 10px;border-radius:999px;background:#eef2ff;color:#4338ca;font-weight:700}
    .timer{font-variant-numeric:tabular-nums; visibility:hidden;}
    .footer{position:fixed;left:0;right:0;bottom:0;background:rgba(255,255,255,.9);
      border-top:1px solid #e5e7eb;backdrop-filter: blur(6px)}
    .footer .inner{max-width:720px;margin:0 auto;padding:10px 16px;display:flex;gap:12px}
    .result h2{margin:0 0 8px}
    .small{font-size:12px;color:#6b7280}
    /* 管理面板 */
    dialog{border:none;border-radius:16px;padding:0;max-width:820px;width:92%}
    .dlg-hd{padding:14px 16px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center}
    .dlg-bd{padding:16px}
    textarea{width:100%;min-height:300px;border:1px solid #e5e7eb;border-radius:12px;padding:12px;font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace}
    .hidden{display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1 id="title">小言測驗（Web）</h1>
      <div class="row">
        <!-- 管理入口不顯示在UI，留一個細小圖示方便妳確認是否為管理模式 -->
        <span id="admin-badge" class="small" style="display:none;color:#4338ca">管理模式</span>
      </div>
    </header>

    <div id="last" class="card" style="display:none;margin-bottom:12px;"></div>

    <div id="quiz" class="card" style="display:none;">
      <div class="meta">
        <div><span id="progress" class="pill">1/1</span></div>
        <div class="timer">剩餘 <span id="remain">10:00</span></div>
      </div>
      <h2 id="q" class="q-text"></h2>
      <div id="choices" style="display:grid;gap:10px;"></div>
    </div>

    <div id="result" class="card result" style="display:none;"></div>

    <div id="home" class="card">
      <p style="margin:0 0 12px;">這是手機瀏覽器就能玩的測驗。選擇模式開始作答：</p>
      <div class="row" style="gap:8px;margin-top:8px;flex-wrap:wrap">
        <button id="start-free" class="btn">開始測驗（不限時）</button>
        <button id="start-10m" class="btn ghost">開始測驗（限時 10 分鐘）</button>
      </div>
      <!-- 給出題者的提示（一般人看不到） -->
      <p id="admin-hint" class="small hidden" style="margin-top:10px">
        已進入管理模式：點右下「管理題庫」可檢視/編輯；或用網址參數 ?admin=1 進入。
      </p>
    </div>
  </div>

  <div class="footer">
    <div class="inner">
      <button id="next" class="btn" disabled>下一題</button>
      <button id="submit" class="btn ghost" disabled>交卷</button>
      <button id="admin-open" class="btn ghost hidden" title="開啟題庫管理">管理題庫</button>
    </div>
  </div>

  <!-- 題庫管理對話框（只有管理模式會用到） -->
  <dialog id="dlg">
    <div class="dlg-hd">
      <strong>題庫管理</strong>
      <button id="dlg-close" class="ghost" style="border:none;background:#eee;border-radius:8px;padding:6px 10px;cursor:pointer">關閉</button>
    </div>
    <div class="dlg-bd">
      <p class="small" style="margin-top:0">格式：<code>[{"q":"題目","choices":["A","B","C","D"],"answer":1}]</code>，<code>answer</code> 從 0 計數。</p>
      <textarea id="editor-ta"></textarea>
      <div class="row" style="margin-top:10px">
        <button id="save-bank" class="btn">儲存題庫</button>
        <button id="reset-bank" class="btn ghost" title="恢復預設題庫">恢復預設</button>
        <button id="export-bank" class="btn ghost" title="下載 JSON">下載題庫</button>
        <input id="import-file" type="file" accept="application/json" class="hidden" />
        <button id="import-bank" class="btn ghost" title="匯入 JSON">匯入題庫</button>
      </div>
    </div>
  </dialog>

<script>
/** ============== 可調整設定（出題者請改這裡） ============== */
// 管理密碼（請改成妳自己的）。僅作前端遮掩，非真正安全管制。
const ADMIN_CODE = "rouye-quiz-2025";
// 是否允許用網址 ?admin=1 觸發管理模式
const URL_ENABLE_ADMIN = true;

/** ===== 題庫（僅供第一次載入；之後以 localStorage 為主） ===== */
const DEFAULT_BANK = [
  {"q":"下列哪個是哺乳類？","choices":["青蛙","鯨魚","麻雀","烏龜"],"answer":1},
  {"q":"2 + 2 = ?","choices":["3","4","5","22"],"answer":1},
  {"q":"台灣最高峰？","choices":["雪山","玉山","合歡主峰","南湖大山"],"answer":1}
];

/** ===== 小工具 ===== */
const $ = sel => document.querySelector(sel);
const $$ = sel => document.querySelectorAll(sel);
function show(el, on=true){ el.classList.toggle('hidden', !on); if(!on) el.style.display=''; }
function pad(n){ return n<10?("0"+n):(""+n); }
function toMMSS(sec){ const m = Math.floor(sec/60), s = sec%60; return `${pad(m)}:${pad(s)}`; }

/** ===== 題庫存取（localStorage） ===== */
function loadBank(){
  try{
    const s = localStorage.getItem('quiz_bank');
    if(!s) return structuredClone(DEFAULT_BANK);
    const arr = JSON.parse(s);
    return Array.isArray(arr) ? arr : structuredClone(DEFAULT_BANK);
  }catch{ return structuredClone(DEFAULT_BANK); }
}
function saveBank(arr){ localStorage.setItem('quiz_bank', JSON.stringify(arr)); }

/** ===== 狀態 ===== */
let bank = loadBank();
let idx = 0;
let score = 0;
let selected = null;
let enableTimer = false;
let duration = 0;       // 秒
let remaining = 0;      // 秒
let tick = null;
let startedAt = null;
let adminMode = false;

/** ===== 初始化：管理模式偵測（三種入口） =====
 *  1) 網址 ?admin=1 會觸發密碼詢問（若 URL_ENABLE_ADMIN 為 true）
 *  2) 連點標題 5 下
 *  3) 長按標題 1.5 秒
 */
(function detectAdmin(){
  function enterAdminFlow(){
    const code = prompt("請輸入管理密碼：");
    if(code === ADMIN_CODE){
      adminMode = true; activateAdminUI();
    }else if(code !== null){
      alert("密碼錯誤");
    }
  }
  if(URL_ENABLE_ADMIN && new URLSearchParams(location.search).get('admin') === '1'){
    // 延遲一下讓頁面穩定
    setTimeout(enterAdminFlow, 10);
  }
  // 連點 5 下
  let taps = 0; let tapTimer = null;
  $('#title').addEventListener('click', ()=>{
    taps++; clearTimeout(tapTimer);
    tapTimer = setTimeout(()=>taps=0, 600);
    if(taps>=5){ taps = 0; enterAdminFlow(); }
  });
  // 長按 1.5 秒
  let pressTimer = null;
  function startPress(){ pressTimer = setTimeout(enterAdminFlow, 1500); }
  function endPress(){ clearTimeout(pressTimer); }
  $('#title').addEventListener('mousedown', startPress);
  $('#title').addEventListener('touchstart', startPress);
  $('#title').addEventListener('mouseup', endPress);
  $('#title').addEventListener('mouseleave', endPress);
  $('#title').addEventListener('touchend', endPress);
})();

function activateAdminUI(){
  $('#admin-badge').style.display = '';
  show($('#admin-hint'), true);
  show($('#admin-open'), true);
}

/** ===== 上次成績 ===== */
function updateLast(){
  const lastBox = $('#last');
  const s = localStorage.getItem('last_score');
  const t = localStorage.getItem('last_seconds');
  if(s){
    lastBox.style.display = '';
    lastBox.innerHTML = `<b>上次成績：</b>${s} 分 <span class="small">（花費 ${t ?? '-'} 秒）</span>`;
  }else{
    lastBox.style.display = 'none';
  }
}
updateLast();

/** ===== 事件綁定 ===== */
$('#start-free').addEventListener('click', ()=>startQuiz({timed:false}));
$('#start-10m').addEventListener('click', ()=>startQuiz({timed:true, seconds:600}));
$('#next').addEventListener('click', nextQuestion);
$('#submit').addEventListener('click', finishQuiz);

// 管理對話框
$('#admin-open').addEventListener('click', openEditor);
$('#dlg-close').addEventListener('click', ()=>$('#dlg').close());
$('#save-bank').addEventListener('click', saveEditor);
$('#reset-bank').addEventListener('click', ()=>{
  saveBank(DEFAULT_BANK); bank = loadBank();
  $('#editor-ta').value = JSON.stringify(bank, null, 2);
  alert('已恢復預設題庫。');
});
$('#export-bank').addEventListener('click', ()=>{
  const blob = new Blob([JSON.stringify(loadBank(), null, 2)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'quiz_bank.json';
  a.click();
});
$('#import-bank').addEventListener('click', ()=>$('#import-file').click());
$('#import-file').addEventListener('change', (e)=>{
  const f = e.target.files?.[0]; if(!f) return;
  const fr = new FileReader();
  fr.onload = ()=>{ try{
      const arr = JSON.parse(fr.result);
      if(!Array.isArray(arr)) throw new Error('JSON 需為陣列');
      validateBank(arr); saveBank(arr); bank = loadBank();
      alert('匯入成功！');
      $('#editor-ta').value = JSON.stringify(bank, null, 2);
    }catch(err){ alert('匯入失敗：'+err.message); } };
  fr.readAsText(f, 'utf-8');
});

/** ===== 測驗流程 ===== */
function startQuiz({timed, seconds=0}){
  bank = loadBank();
  idx = 0; score = 0; selected = null;
  startedAt = Date.now();
  enableTimer = !!timed;
  duration = seconds|0;
  remaining = duration;
  clearInterval(tick);

  // UI
  $('#remain').textContent = enableTimer ? toMMSS(remaining) : '—';
  $('.timer').style.visibility = enableTimer ? 'visible' : 'hidden';
  $('#submit').disabled = false;
  $('#next').disabled = true;
  $('#home').style.display = 'none';
  $('#result').style.display = 'none';
  $('#quiz').style.display = '';

  renderQuestion();

  if(enableTimer){
    tick = setInterval(()=>{
      remaining--;
      $('#remain').textContent = toMMSS(Math.max(0, remaining));
      if(remaining<=0){ finishQuiz(); }
    }, 1000);
  }
  window.scrollTo({top:0,behavior:'smooth'});
}

function renderQuestion(){
  const q = bank[idx];
  $('#progress').textContent = `${idx+1}/${bank.length}`;
  $('#q').textContent = q.q;
  const box = $('#choices');
  box.innerHTML = '';
  q.choices.forEach((text, i)=>{
    const div = document.createElement('label');
    div.className = 'choice';
    div.innerHTML = `<input type="radio" name="c${idx}" /> <span>${text}</span>`;
    div.addEventListener('click', ()=>{
      selected = i;
      $('#next').disabled = false;
      if(idx === bank.length - 1){ $('#next').textContent = '交卷'; }
      else { $('#next').textContent = '下一題'; }
    });
    box.appendChild(div);
  });
}

function nextQuestion(){
  if(idx === bank.length - 1){ finishQuiz(); return; }
  if(selected === bank[idx].answer) score++;
  idx++; selected = null;
  $('#next').disabled = true;
  renderQuestion();
}

function finishQuiz(){
  clearInterval(tick);
  if(selected !== null && idx < bank.length){
    if(selected === bank[idx].answer) score++;
  }
  const elapsed = Math.max(1, Math.round((Date.now() - startedAt)/1000));
  const total = bank.length;
  const pct = Math.round((score/total)*100);

  // 存檔
  localStorage.setItem('last_score', String(score));
  localStorage.setItem('last_seconds', String(elapsed));
  updateLast();

  $('#result').innerHTML = `
    <h2>成績：${score} / ${total}</h2>
    <p class="small">正確率 ${pct}% ・ 花費 ${elapsed} 秒${enableTimer?`（限時 ${toMMSS(duration)}）`:''}</p>
    <div class="row" style="margin-top:8px">
      <button class="btn" onclick="startQuiz({timed:${enableTimer}, seconds:${duration}})">再測一次</button>
      <button class="btn ghost" onclick="(document.querySelector('#result').style.display='none',document.querySelector('#home').style.display='')">回首頁</button>
    </div>
  `;
  $('#quiz').style.display = 'none';
  $('#home').style.display = 'none';
  $('#result').style.display = '';
  $('#next').disabled = true;
  $('#submit').disabled = true;
}

/** ===== 題庫管理（僅管理模式可見） ===== */
function openEditor(){
  $('#editor-ta').value = JSON.stringify(loadBank(), null, 2);
  $('#dlg').showModal();
}
function validateBank(arr){
  for(const it of arr){
    if(typeof it.q!=='string' || !Array.isArray(it.choices) || typeof it.answer!=='number')
      throw new Error('每題需包含 q(字串)、choices(陣列)、answer(數字)');
  }
}
function saveEditor(){
  try{
    const arr = JSON.parse($('#editor-ta').value);
    if(!Array.isArray(arr)) throw new Error('格式需為陣列');
    validateBank(arr);
    saveBank(arr); bank = loadBank();
    alert('已儲存題庫！');
    $('#dlg').close();
  }catch(err){ alert('存檔失敗：' + err.message); }
}
</script>
</body>
</html>
